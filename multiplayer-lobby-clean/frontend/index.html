<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monkey's Paw</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">

  <div id="lobby" class="card">
    <h1>Monkey's Paw</h1>
    <div class="button-group">
      <button id="createLobbyBtn" class="btn primary">Create Lobby</button>
      <button id="joinLobbyBtn" class="btn secondary">Join Lobby</button>
    </div>
    <div id="lobbyForm" class="form" style="display:none;">
      <input type="text" id="lobbyName" placeholder="Lobby Name">
      <input type="password" id="password" placeholder="Password">
      <button id="submitLobbyBtn" class="btn primary">Submit</button>
    </div>
  </div>

  <div id="game" class="card" style="display:none;">
    <h2>Game Room</h2>
    <div id="playerList" class="player-list"></div>
    
    <div id="gamePanel" style="display:none;">
      <p id="roundInfo" class="round-info"></p>
      <p id="wish" class="wish"></p>

      <div id="submissionArea" style="display:none;">
        <textarea id="curseInput" placeholder="Write your curse here..."></textarea>
        <button id="submitCurseBtn" class="btn primary">Submit Curse</button>
      </div>

      <div id="voteArea" style="display:none;" class="vote-area"></div>
    </div>
  </div>

</div>

<script>
const ws = new WebSocket('ws://localhost:3000/ws');

let isWisher = false;
let submissions = [];

const lobbyDiv = document.getElementById('lobby');
const lobbyForm = document.getElementById('lobbyForm');
const gameDiv = document.getElementById('game');
const gamePanel = document.getElementById('gamePanel');
const playerListDiv = document.getElementById('playerList');
const roundInfo = document.getElementById('roundInfo');
const wishPara = document.getElementById('wish');
const submissionArea = document.getElementById('submissionArea');
const curseInput = document.getElementById('curseInput');
const voteArea = document.getElementById('voteArea');

document.getElementById('createLobbyBtn').onclick = () => {
  lobbyForm.style.display = 'block';
};

document.getElementById('joinLobbyBtn').onclick = () => {
  lobbyForm.style.display = 'block';
};

document.getElementById('submitLobbyBtn').onclick = () => {
  const lobbyName = document.getElementById('lobbyName').value;
  const password = document.getElementById('password').value;
  const action = lobbyName && password ? 'create_lobby' : 'join_lobby';
  ws.send(JSON.stringify({ type: action, lobbyName, password }));
};

ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  switch(msg.type){
    case 'error':
      alert(msg.message);
      break;
    case 'created':
    case 'joined':
      lobbyDiv.style.display = 'none';
      gameDiv.style.display = 'block';
      break;
    case 'lobby_update':
      playerListDiv.innerHTML = 'Players: ' + msg.lobby.players.map(p => p.name + ' (' + p.score + ')').join(', ');
      break;
    case 'game_started':
      gamePanel.style.display = 'block';
      roundInfo.textContent = 'Round ' + msg.round;
      break;
    case 'wish_drawn':
      wishPara.textContent = 'Wish: ' + msg.wish;
      submissionArea.style.display = 'block';
      isWisher = true;
      break;
    case 'reveal':
      voteArea.style.display = 'block';
      voteArea.innerHTML = '';
      submissions = msg.submissions;
      submissions.forEach((c, i) => {
        const btn = document.createElement('button');
        btn.textContent = c;
        btn.className = 'btn vote-btn';
        btn.onclick = () => ws.send(JSON.stringify({ type: 'vote', curseIndex: i }));
        voteArea.appendChild(btn);
      });
      break;
    case 'new_round':
      roundInfo.textContent = 'Round ' + msg.round;
      submissionArea.style.display = msg.isWisher ? 'block' : 'none';
      voteArea.style.display = 'none';
      wishPara.textContent = '';
      isWisher = msg.isWisher;
      break;
    case 'round_finished':
      alert(msg.winner + ' won this round! New score: ' + msg.score);
      break;
  }
};

document.getElementById('submitCurseBtn').onclick = () => {
  const curse = curseInput.value;
  if(curse) {
    ws.send(JSON.stringify({ type: 'submit_curse', curse }));
    submissionArea.style.display = 'none';
    curseInput.value = '';
  }
};
</script>
</body>
</html>

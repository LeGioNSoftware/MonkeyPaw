<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer Game</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  input, button { margin: 5px; }
  #gameScreen { display: none; }
</style>
</head>
<body>

<h2>Login / Create Lobby</h2>
<label>Username: <input type="text" id="username"></label><br>
<label>Lobby Name: <input type="text" id="lobbyName"></label><br>
<label>Lobby Password: <input type="password" id="lobbyPassword"></label><br>
<button id="createLobbyBtn" disabled>Create Lobby</button>
<button id="joinLobbyBtn" disabled>Join Lobby</button>

<div id="gameScreen">
  <h2>Game Lobby</h2>
  <div id="players"></div>
  <div id="cards"></div>
</div>

<script>
let socket = null;
let username = '';
let lobbyName = '';
let votes = {}; // to store votes anonymously

function initWebSocket() {
    const wsUrl = window.location.hostname === 'localhost'
        ? 'ws://localhost:3000'
        : 'wss://monkeypaw.onrender.com';

    socket = new WebSocket(wsUrl);

    socket.onopen = () => {
        console.log('WebSocket connected');
        document.getElementById('createLobbyBtn').disabled = false;
        document.getElementById('joinLobbyBtn').disabled = false;
    };

    socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleServer(msg);
    };

    socket.onclose = () => {
        console.log('WebSocket disconnected');
        alert('Disconnected from server.');
    };

    socket.onerror = (err) => {
        console.error('WebSocket error:', err);
        alert('WebSocket connection error.');
    };
}

window.addEventListener('load', initWebSocket);

document.getElementById('createLobbyBtn').addEventListener('click', () => {
    username = document.getElementById('username').value.trim();
    lobbyName = document.getElementById('lobbyName').value.trim();
    const password = document.getElementById('lobbyPassword').value;

    if (!username || !lobbyName) {
        alert('Please enter a username and lobby name.');
        return;
    }

    socket.send(JSON.stringify({
        type: 'create_lobby',
        lobbyName,
        password,
        username
    }));
});

document.getElementById('joinLobbyBtn').addEventListener('click', () => {
    username = document.getElementById('username').value.trim();
    lobbyName = document.getElementById('lobbyName').value.trim();
    const password = document.getElementById('lobbyPassword').value;

    if (!username || !lobbyName) {
        alert('Please enter a username and lobby name.');
        return;
    }

    socket.send(JSON.stringify({
        type: 'join_lobby',
        lobbyName,
        password,
        username
    }));
});

function handleServer(msg) {
    switch(msg.type) {
        case 'lobby_created':
        case 'joined_lobby':
            document.getElementById('gameScreen').style.display = 'block';
            updatePlayers(msg.players);
            break;
        case 'new_player':
            updatePlayers(msg.players);
            break;
        case 'vote_update':
            votes[msg.user] = msg.card; // store votes anonymously
            break;
        case 'reveal_votes':
            alert('Voting results:\n' + JSON.stringify(msg.results, null, 2));
            break;
        default:
            console.log('Unknown message', msg);
    }
}

function updatePlayers(players) {
    const div = document.getElementById('players');
    div.innerHTML = '<strong>Players:</strong> ' + players.join(', ');
}
</script>

</body>
</html>
